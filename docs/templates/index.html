<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CyberVault Platformu</title>
	<link rel="icon" type="image/png" href="{{ url_for('static', filename='logo.png') }}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js'></script>

    <style>
        body { background-color: #0d1117; color: #c9d1d9; font-family: 'Segoe UI', monospace; }
        
        /* Kart TasarÄ±mlarÄ± */
        .card { background-color: #161b22; border: 1px solid #30363d; margin-bottom: 20px; transition: transform 0.2s; }
        .card:hover { transform: translateY(-5px); border-color: #58a6ff; }
        .card-title { color: #58a6ff; font-weight: bold; }
        
        /* Badges */
        .badge-ctf { background-color: #238636; }
        .badge-conf { background-color: #a371f7; }
        
        /* Logo ve Header */
        .logo-container { text-align: center; margin-top: 20px; margin-bottom: 20px; }
        .logo-img { max-width: 300px; height: auto; }
        
        /* Tabs (Sekmeler) */
        .nav-tabs .nav-link { color: #8b949e; border: 1px solid transparent; }
        .nav-tabs .nav-link.active { background-color: #161b22; color: #58a6ff; border-color: #30363d #30363d #161b22; }
        .nav-tabs { border-bottom: 1px solid #30363d; margin-bottom: 20px; }

        /* Bildirim AlanÄ± */
        .notification-area { position: absolute; top: 20px; right: 20px; cursor: pointer; z-index: 1000; }
        .notification-area:hover i { color: #58a6ff !important; }

        /* YENÄ°: Bildirim Modal TasarÄ±mÄ± (Dark Mode) */
        .modal-content { background-color: #161b22; border: 1px solid #30363d; color: #c9d1d9; }
        .modal-header { border-bottom: 1px solid #30363d; }
        .modal-footer { border-top: 1px solid #30363d; }
        .btn-close { filter: invert(1) grayscale(100%) brightness(200%); }
        .list-group-item { background-color: #0d1117; border-color: #30363d; color: white; }
        
        /* ArÅŸiv Tablosu */
        .table-dark { background-color: #161b22; --bs-table-bg: #161b22; color: #c9d1d9; border-color: #30363d; }
    </style>
</head>
<body>

<div class="notification-area" data-bs-toggle="modal" data-bs-target="#notificationModal">
    <i class="bi bi-bell-fill" style="font-size: 1.5rem; color: #c9d1d9;"></i>
    <span id="notif-badge" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" style="display:none;">
        0
    </span>
</div>

<div class="modal fade" id="notificationModal" tabindex="-1" aria-labelledby="notificationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-white" id="notificationModalLabel">ğŸ”” Bildirim Merkezi</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
            </div>
            <div class="modal-body">
                <p id="notif-status" class="small text-muted">Web Security alanÄ±ndaki yeni fÄ±rsatlar:</p>
                <div class="list-group" id="notification-list">
                    </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-sm btn-outline-secondary" data-bs-dismiss="modal">Kapat</button>
                <button type="button" class="btn btn-sm btn-primary" onclick="markAsRead()">Hepsini Okundu Ä°ÅŸaretle</button>
            </div>
        </div>
    </div>
</div>

<div class="container">
    <div class="logo-container">
        <img src="{{ url_for('static', filename='logo.png') }}" alt="CyberVault Logo" class="img-fluid logo-img">
        <p class="text-white mt-2">Track. Conquer. Archive.</p>
    </div>

    <ul class="nav nav-tabs" id="myTab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="list-tab" data-bs-toggle="tab" data-bs-target="#listView" type="button">ğŸ“Œ Etkinlik Listesi</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="calendar-tab" data-bs-toggle="tab" data-bs-target="#calendarView" type="button">ğŸ“… Ä°nteraktif Takvim</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="archive-tab" data-bs-toggle="tab" data-bs-target="#archiveView" type="button">ğŸ“š ArÅŸiv & Write-ups</button>
        </li>
    </ul>

    <div class="tab-content" id="myTabContent">
        
        <div class="tab-pane fade show active" id="listView">
            <div class="d-flex justify-content-center mb-4">
                <span class="me-3 align-self-center text-white">Ä°lgi AlanÄ± Filtrele:</span>
                <button class="btn btn-sm btn-outline-light me-1" onclick="loadList('all')">TÃ¼mÃ¼</button>
                <button class="btn btn-sm btn-outline-danger me-1" onclick="loadList('pwn')">Pwn</button>
                <button class="btn btn-sm btn-outline-info me-1" onclick="loadList('web')">Web</button>
                <button class="btn btn-sm btn-outline-warning" onclick="loadList('crypto')">Crypto</button>
            </div>
            <div id="events-card-container" class="row">
                <div class="text-center text-light">Veriler yÃ¼kleniyor...</div>
            </div>
        </div>

        <div class="tab-pane fade" id="calendarView">
            <div id='calendar' style="background-color: #f0f6fc; padding: 10px; border-radius: 5px; color: #000;"></div>
        </div>

        <div class="tab-pane fade" id="archiveView">
            <h5 class="text-white mb-3">ğŸ“ GeÃ§miÅŸ Etkinlik ArÅŸivi ve Ã‡Ã¶zÃ¼mler</h5>
            <table class="table table-dark table-hover">
                <thead>
                    <tr>
                        <th>Etkinlik AdÄ±</th>
                        <th>Tarih</th>
                        <th>Kategori</th>
                        <th>Dosya</th>
                    </tr>
                </thead>
                <tbody id="archive-table-body">
                    </tbody>
            </table>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    let allEventsData = []; 

    async function fetchData() {
        try {
            const response = await fetch('/api/events');
            allEventsData = await response.json();
            
            loadList('all'); 
            initCalendar();
            checkNotifications(); // Bildirimleri kontrol et ve yÃ¼kle
        } catch (error) {
            console.error("Veri hatasÄ±:", error);
            document.getElementById('events-card-container').innerHTML = '<p class="text-danger text-center">Veri Ã§ekilemedi.</p>';
        }
    }

    function loadList(filter) {
        const container = document.getElementById('events-card-container');
        container.innerHTML = '';
        
        const filtered = filter === 'all' 
            ? allEventsData 
            : allEventsData.filter(e => (e.title + e.tags).toLowerCase().includes(filter));

        if(filtered.length === 0) {
            container.innerHTML = '<p class="text-center text-muted">Bu filtreye uygun etkinlik yok.</p>';
            return;
        }

        filtered.forEach(event => {
            let badgeClass = event.type === 'CTF' ? 'badge-ctf' : 'badge-conf';
            container.innerHTML += `
                <div class="col-md-6 col-lg-4">
                    <div class="card h-100">
                        <div class="card-body">
                            <span class="badge ${badgeClass} mb-2">${event.type}</span>
                            <h5 class="card-title">${event.title}</h5>
                            <p class="text-white small mb-1">ğŸ“… ${event.start}</p>
                            <p class="text-white small">ğŸ® Format: ${event.format}</p>
                            <a href="${event.url}" target="_blank" class="btn btn-sm btn-outline-primary w-100">Ä°ncele</a>
                        </div>
                    </div>
                </div>
            `;
        });
    }

    function initCalendar() {
        var calendarEl = document.getElementById('calendar');
        var calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,listWeek'
            },
            events: allEventsData,
            eventClick: function(info) {
                if(info.event.url) {
                    window.open(info.event.url, "_blank");
                    info.jsEvent.preventDefault(); 
                }
            }
        });
        
        document.getElementById('calendar-tab').addEventListener('shown.bs.tab', function () {
            calendar.render();
        });
    }

    async function loadArchive() {
        try {
            const response = await fetch('/api/archive');
            const data = await response.json();
            const tbody = document.getElementById('archive-table-body');
            
            data.forEach(item => {
                tbody.innerHTML += `
                    <tr>
                        <td>${item.title}</td>
                        <td>${item.date}</td>
                        <td><span class="badge bg-secondary">${item.category}</span></td>
                        <td><a href="#" class="btn btn-sm btn-success">â¬‡ï¸ ${item.file_type}</a></td>
                    </tr>
                `;
            });
        } catch (e) { console.log("ArÅŸiv yÃ¼klenemedi"); }
    }

    // --- GÃœNCELLENEN BÄ°LDÄ°RÄ°M SÄ°STEMÄ° ---
    function checkNotifications() {
        // KullanÄ±cÄ± tercihi simÃ¼lasyonu
        const userInterest = "web"; 
        
        // Ä°lgili etkinlikleri bul
        const interestedEvents = allEventsData.filter(e => (e.tags).includes(userInterest));
        const count = interestedEvents.length;
        
        // Rozet (Badge) GÃ¼ncelleme
        const badge = document.getElementById('notif-badge');
        
        if(count > 0) {
            badge.innerText = count;
            badge.style.display = 'block';
            
            // Modal Ä°Ã§eriÄŸini Doldurma
            const listContainer = document.getElementById('notification-list');
            listContainer.innerHTML = ''; // Ã–nce temizle
            
            interestedEvents.forEach(ev => {
                listContainer.innerHTML += `
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <strong class="text-white">${ev.title}</strong><br>
                            <small class="text-muted">${ev.start}</small>
                        </div>
                        <a href="${ev.url}" target="_blank" class="btn btn-sm btn-outline-info">Git</a>
                    </div>
                `;
            });
            
            document.getElementById('notif-status').innerText = `'${userInterest.toUpperCase()}' kategorisinde ${count} yeni etkinlik var!`;
        } else {
            document.getElementById('notification-list').innerHTML = '<div class="text-center p-3 text-muted">Yeni bildirim yok.</div>';
        }
    }
    
    // Bildirimleri Okundu Sayma Fonksiyonu
    function markAsRead() {
        const badge = document.getElementById('notif-badge');
        badge.style.display = 'none'; // KÄ±rmÄ±zÄ± rozeti gizle
        
        const listContainer = document.getElementById('notification-list');
        listContainer.innerHTML = '<div class="text-center p-3 text-success">ğŸ‰ TÃ¼m bildirimler okundu!</div>';
        
        // ModalÄ± 1 saniye sonra kapat (isteÄŸe baÄŸlÄ±)
        // setTimeout(() => { bootstrap.Modal.getInstance(document.getElementById('notificationModal')).hide(); }, 1500);
    }

    window.onload = () => {
        fetchData();
        loadArchive();
    };
</script>

</body>
</html>